/**
* @preserve ====================================================================
* Copyright 1997, 2021. Proiecto, C. A. Todos los derechos reservados.
* Proiecto, Proiecto BackOffice, Proiecto BackOffice Server, Proiecto Salomón
* y Proiecto Web Services, son marcas registradas de Proiecto, C. A.
* El eslogan: 'Plataforma de servicios en la nube', es marca registrada de
* Proiecto, C. A. Otros productos citados son marcas registradas de sus
* respectivos propietarios y/o fabricantes.
* Producto desarrollado por Edward Ocando con licencia para uso exclusivo de
* Proiecto, C. A. Para más información visite https://www.proiecto.net, ó 
* si lo desea, puede escribir a: 
* info@proiecto.net, ventas@proiecto.net ó soporte@proiecto.net
* ====================================================================
* THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
* LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
* OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
* WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
* ====================================================================
*/

"use strict";

// Para trabajar las fechas de forma correcta
// DOC: Para trabajar con la fecha en JS
// 	new Date('2020-12-11T00:00:00')
// 	new Date('FECHA_DESDE_NET')
// y viceversa usar: 
//	$BCL.FormatDate(new Date('2020-12-11T00:00:00'), 'd/M/yyyy')
// 	$BCL.FormatDate(new Date('2020-12-11T00:00:00'), 'yyyy,M,d')

// =============================================================
// $sessionToken: sesion del usuario logueado...
// =============================================================
if(typeof $sessionToken === "undefined" || !$sessionToken) {
	var $sessionToken = {};
};


function tokenReset() {
	$sessionToken.sesionUID = null;
	localStorage.removeItem('sessionToken')
};

// =============================================================
// Samples
// =============================================================
// if(!localStorage.getItem('sessionToken')){}
// localStorage.setItem('sessionToken', "...");

// $sessionToken = JSON.parse(localStorage.getItem('sessionToken')); // get JSON
// localStorage.setItem('sessionToken', JSON.stringify($sessionToken)); // save JSON
// =============================================================

// =============================================================
// Session Token
// =============================================================
$sessionToken.horaInicioAplicacion = new Date();
$sessionToken.sesionUID = null; // Se asigna valor cuando se realiza el login del usuario
$sessionToken.ultimaVerificacionToken = new Date(); // Ultima vez que se verifico el token
$sessionToken.idiomaId = lGet();

// =============================================================
// El valor de estas propiedades determina si se puede o no usar la aplicación
// En cada proceso SIEMPRE validar y no permitir avanzar si no se cumple: 
//	--> $sessionToken.accesoRed = true;
//	--> 
// =============================================================
// if (!$sessionToken.accesoRed){alertaNoAccesoRed();return;}
// =============================================================
$sessionToken.accesoRed = true;

// =============================================================

// =============================================================
// Controla la politicas de coikies del 
// Reglamento General de Protección de Datos (GDPR)
// Es el reglamento europeo relativo a la protección de las personas físicas en lo que 
// respecta al tratamiento de sus datos personales y a la libre circulación de estos datos.
// Es una normativa a nivel de la Unión Europea, por lo que cualquier empresa de la unión, o 
// aquellas empresas que tengan negocios en la Unión Europea, que manejen información 
// personal de cualquier tipo, deberán acogerse a ella. 
// =============================================================
$sessionToken.gdprMarketing = false;
$sessionToken.gdprPreferences = false;
$sessionToken.gdprAnalytics = false;
// =============================================================

// =============================================================
// ToDo: Hacer lo mismo para los otros idiomas...
// =============================================================
if($sessionToken.idiomaId === "es") { $appConfig.formatoFecha = 'd/M/yyyy' };
if($sessionToken.idiomaId === "en") { $appConfig.formatoFecha = 'M/d/yyyy' };
if($sessionToken.idiomaId === "jp") { $appConfig.formatoFecha = 'yyyy/M/d' };
// =============================================================

// Arreglo con listado de Servicios activos 
// asociados al CLUF actual --> $BCL.getUrlSubDomain()
$sessionToken.listaServiciosEnClufs = {};
$sessionToken.numeroDeServiciosEnCluf = 0; // $sessionToken.numeroDeServiciosEnCluf = numeroDeServiciosEnCluf();
$sessionToken.servicioSeleccionado = "";
$sessionToken.servicioSeleccionadoAlias = "";

$sessionToken.empresaNombre = "";
$sessionToken.empresaID = 1; // (demo.proiecto.net) 
$sessionToken.empresaLegalId = "";
$sessionToken.empresaAlias = $BCL.getUrlSubDomain();

$sessionToken.empresaSimboloMoneda = "";
$sessionToken.empresaDireccion = "";
$sessionToken.empresaCiudad = "";
$sessionToken.empresaRegion = "";
$sessionToken.empresaPais = "";
$sessionToken.empresaPaisId = "";
$sessionToken.empresaCodigoPostal = "";
$sessionToken.empresaTelefono = "";
$sessionToken.empresaZonaHoraria = 0;


$sessionToken.usuarioUID = "000-000-000-000-000"; // (19) 
$sessionToken.usuarioNombre = "";
$sessionToken.usuarioNombreCompleto = "";
$sessionToken.usuarioAvatarURL = "";
$sessionToken.usuarioEmail = "";

















// Optenidas en: getGeoInfo();
$sessionToken.sesionPais = "";
$sessionToken.sesionPaisCodigo = "";
$sessionToken.sesionRegion = "";
$sessionToken.sesionRegionNombre = "";
$sessionToken.sesionCiudad = "";
$sessionToken.sesionGeoLat = 0;
$sessionToken.sesionGeoLon = 0;
$sessionToken.sesionZonaHoraria = "";
$sessionToken.sesionIp = "127.0.0.1";
$sessionToken.sesionCodigoPostal = "";
$sessionToken.sesionCodigoIsp = "";



$sessionToken.osNombre = "";
$sessionToken.usuarioAgente = "";






// ============================================================
let $alertaAvisoActivo = false;
// ============================================================



// ============================================================
// Ocurre --> window.addEventListener("offline", () => {...}
// ============================================================
function alertaNoAccesoRed() {
	// ============================================================
	// No notificar si hay un aviso en pantalla
	// ============================================================
	if($alertaAvisoActivo) { return false; };
	$alertaAvisoActivo = true;
	// ============================================================
	$.alert({
		boxWidth: '90%',
		useBootstrap: false,
		// columnClass: 'small' // default        
		// Available animations:
		// right, left, bottom, top, rotate, none, opacity, scale, zoom,
		// scaleY, scaleX, rotateY, rotateYR (reverse), rotateX, rotateXR (reverse)
		animation: 'opacity',
		closeAnimation: 'scale',
		animationBounce: 2, // default is 1.2 whereas 1 is no bounce.
		escapeKey: false,
		// titleClass: '',
		// typeAnimated: true,
		closeIcon: false,
		// closeIconClass: 'fa fa-close',
		draggable: true,
		type: 'red',
		icon: 'fa fa-hand-stop-o',
		title: l('AVISO_NO_CONEXION_RED_TITULO'),
		dragWindowGap: 100,
		content: l('AVISO_NO_CONEXION_RED_CONTENIDO1') + '<br>' +
			l('AVISO_NO_CONEXION_RED_CONTENIDO2') + '<br>' +
			l('AVISO_NO_CONEXION_RED_CONTENIDO3'),
		onDestroy: function() {
			$alertaAvisoActivo = false;
			return true;
		}
	});
};
// ============================================================

// ============================================================
// Ocurre --> window.addEventListener("online", () => {...}
// ============================================================
function alertaAccesoRedRecuperado() {
	// ============================================================
	// No notificar si hay un aviso en pantalla
	// ============================================================
	if($alertaAvisoActivo) { return false; };
	$alertaAvisoActivo = true;
	// ============================================================

	$sessionToken.accesoRed = true;
	var x0 = setToken();
	$.alert({
		boxWidth: '90%',
		useBootstrap: false,
		// columnClass: 'small' // default        
		// Available animations:
		// right, left, bottom, top, rotate, none, opacity, scale, zoom,
		// scaleY, scaleX, rotateY, rotateYR (reverse), rotateX, rotateXR (reverse)
		animation: 'opacity',
		closeAnimation: 'scale',
		animationBounce: 2, // default is 1.2 whereas 1 is no bounce.
		escapeKey: false,
		// titleClass: '',
		// typeAnimated: true,
		closeIcon: false,
		// closeIconClass: 'fa fa-close',
		draggable: true,
		type: 'green',
		icon: 'fa fa-hand-o-right',
		title: l('AVISO_CONEXION_RED_TITULO'),
		dragWindowGap: 100,
		content: l('AVISO_CONEXION_RED_CONTENIDO'),
		onDestroy: function() {
			$alertaAvisoActivo = false;
			return true;
		}
	});
};
// ============================================================


// ============================================================
// Mostrar (ocultar) Logo & Avion de Papel (fondo blanco)
// preloader(true, false)
// ============================================================
// 	topbar.show();
// 	topbar.hide();
// ============================================================
function preloader(visibility) {
	if(visibility) {
		$(".preloader").fadeIn(3000); // show
	} else {
		$(".preloader").fadeOut(3000); // hide
	}
};



// ============================================================
// Alerta superior...
// showWarning('Titulo', 'Texto...', 'success', true)
//	success, info, warning, danger
// ============================================================
function showWarning(alertTitle, alertText, styleColor, autoClose) {
	Topper({
		title: alertTitle,
		text: alertText,
		style: styleColor, // Style of the notification: success, info, warning, danger
		// type: 'top',
		autoclose: autoClose,
		autocloseAfter: 5000
	});
};
// ============================================================

// $("#idContent").mask("Por favor espere...no se vlla quedse alli");
// $("#idContent").unmask();

// $("body").mask("Por favor espere...no se vlla quedse alli");
// $("body").unmask();



// ============================================================
// Fondo blanco transparente para modales
// ============================================================
function showMask(visibility) {
	if(visibility) {
		$(".mask").fadeIn(700); // show
	} else {
		$(".mask").fadeOut(700); // hide
	}
};
// ============================================================

// ============================================================
// Este contenedor solo existe en el /index.html principal
// openNav('/pages/demo.html');
// ============================================================
let $alertaContenedorFlotante = false;
function openNav(url) {

	if($alertaContenedorFlotante) {
		$.toast({
			heading: l("AVISO"),
			text: l("HAY_VENTANA_ACTIVA"),
			position: 'top-left',
			beforeShow: function () {},
			afterShown: function () {},
			afterHidden: function () {},
			onClick: function () {},
			beforeHide: function() {
				return false;
			}
		});
	};

	$alertaContenedorFlotante = true;	
	showMask(true);
	var xW = Math.trunc(window.innerWidth * 0.75) + "px";
	document.getElementById("contenedorFlotanteContenido").style.width = xW;
	document.getElementById("contenedorFlotante").style.width = xW;

	if(arguments.length > 0) {
		// ============================================================
		$("#contenedorFlotante").mask(l('POR_FAVOR_ESPERE'), 400);
		// ============================================================

		// Asignar contenido...
		$("#contenedorFlotanteContenido").load(url, function() {



			// ============================================================
			// Al leer contenido a mostrar...
			let x0 = traduceDOM();
			$("#contenedorFlotante").unmask();
			// ============================================================
		});
	};
};

function closeNav() {
	// document.getElementById("contenedorFlotanteContenido").innerHTML = "";
	document.getElementById("contenedorFlotanteContenido").style.width = "0";
	document.getElementById("contenedorFlotante").style.width = "0";
	$alertaContenedorFlotante = false;
	showMask(false);
};
// ============================================================


// ============================================================
// Ejecutar únicamnte en el window.onload = function()
//	Archivo -> window.on.load.js
// ============================================================
function consoleCopyright() {
	console.group("Proiecto");
	console.info(l('ESLOGAN'));
	console.info('https://www.proiecto.net');

	// console.log("Response length: " + (document.getElementsByTagName('html')[0].outerHTML.length / 1024).toFixed(2).toString() + " kbytes.");

	var x0time = ((new Date() - $sessionToken.horaInicioAplicacion) / 1000)
	console.log("Render time: " + ((new Date() - $sessionToken.horaInicioAplicacion) / 1000).toFixed(2).toString() + " seconds.");
	console.groupEnd();

	if(x0time > 17) {
		// Su conexión a la red es considerablemente lenta...
		showWarning(l('AVISO_IMPORTANTE'), l('CONEXION_LENTA'), 'warning', true)
	};
};
// ============================================================

// ============================================================
// window.location sets the URL of your current window. 
// To open a new window, you need to use window.open.
// ============================================================
function goHome() {
	// window.location.replace('https://www.proiecto.net/');
	window.open('//www.proiecto.net/', '_blank');
};
// ============================================================














































































































// ============================================================
// Mostrar ayuda
// ============================================================
function showHelp() {
	// ============================================================
	// No notificar si hay un aviso en pantalla
	// ============================================================
	if($alertaAvisoActivo) {
		alert(l("EXISTEN_AVISOS_ACTIVOS"));
		return false;
	};
	// ============================================================
	$BCL.showPopup('../pages/ayuda/index.html', 500, 500, 100, 'center')
};
// ============================================================




// ============================================================
// Leer infomación asociada a la IP pública
// ============================================================
function getGeoInfo() {
	// =============================================================
	if(!$sessionToken.accesoRed) { alertaNoAccesoRed(); return; }
	// =============================================================
	// ============================================================
	// Obtener datos geográficos
	// ============================================================
	// http://services.proiecto.net:1520/portal/getIpInfo/?ip=198.38.83.167
	// http://services.proiecto.net:1520/portal/getIpInfo/
	// http://ip-api.com/json/198.38.83.167?fields=status,message,country,countryCode,currency,region,regionName,city,zip,lat,lon,timezone,isp,query
	// ============================================================
	// {
	//   "status": "success",
	//   "country": "United States",
	//   "countryCode": "US",
	//   "region": "IL",
	//   "regionName": "Illinois",
	//   "city": "Chicago",
	//   "zip": "60666",
	//   "lat": 41.8781,
	//   "lon": -87.6298,
	//   "timezone": "America/Chicago",
	//   "currency": "USD",
	//   "isp": "Server Central Network",
	//   "query": "198.38.83.167"
	// }
	// ============================================================
	const $url = $appConfig.backOfficeServerUrl + "portal/getIpInfo/";
	let jqXHRGeo = $.ajax({
		beforeSend: function(xhr) {
			// xhr.setRequestHeader('Bertha', 'Magdalena');
		},
		url: $url,
		method: "GET", // "POST", "GET", "PUT"
		data: {},
		async: true
		// dataType: 'json', // xml, json, script, or html
	});
	jqXHRGeo.done(function(data) {
		if(!data) { return; }
		$sessionToken.sesionPais = data.country;
		$sessionToken.sesionPaisCodigo = data.countryCode;
		$sessionToken.sesionRegion = data.region;
		$sessionToken.sesionRegionNombre = data.regionName;
		$sessionToken.sesionCiudad = data.city;
		$sessionToken.sesionGeoLat = data.lat;
		$sessionToken.sesionGeoLon = data.lon;
		$sessionToken.sesionZonaHoraria = data.timezone;
		$sessionToken.sesionIp = data.query;
		$sessionToken.sesionCodigoPostal = data.zip;
		$sessionToken.sesionCodigoIsp = data.isp;
	});
	// jqXHRGeo.always(function(data) {});
	jqXHRGeo.fail(function(jqXHR, textStatus, errorThrown) {
		// jqXHR.responseText -> Contiene el HTML del detalle del error que viene desde IIS
		var xResult = jQueryAjaxAvisoError('Ajax Response status: ' + textStatus);
	});
	// ============================================================
}


function getUserAgent() {

	var $result;
	// ============================================================
	// AJAX (\assets\plugins\jquery\$ajaxCorrecto.js)
	// ============================================================
	var $url = $appConfig.backOfficeServerUrl + "public/getUserAgent";
	let jqXHR = $.ajax({
		url: $url,
		method: "GET",
		data: {},
		async: false
	});
	jqXHR.done(function(data) {
		if(!data) { return; }
		// {"result": "ok", "message": "Chrome 84"}
		$result = data.message;
	});
	jqXHR.fail(function(jqXHR, textStatus, errorThrown) {
		// jQueryAjaxAvisoError('Ajax Response status: ' + textStatus);
	});
	// ============================================================
	if(window.navigator.userAgent.indexOf("Edg") > -1) {
		var version = null;
		var userAgent = navigator.userAgent.toLowerCase();
		var matches = userAgent.match(/edg\/([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)/);
		if(matches) {
			version = matches[1];
		}
		return "Edge " + version;
	} else {
		return $result;
	}
};






// ==================================================================
// capturar boton derecho del mouse sobre algun elemento
// ==================================================================
/*
    <!-- Elemento donde se hace click derecho -->
    <p class="jctx-host jctx-id-foo">Right-click this</p>

    <!-- menu -->
    <!-- White context menu, with icons -->
    <!-- <ul class="jctx jctx-id-bar jctx-white jctx-white-shadow"> -->
    
    <!-- Black context menu, with disabled item -->
    <ul class="jctx jctx-id-foo jctx-black jctx-black-shadow">
        <li data-action="cut">Cut</li>
        <li data-action="copy">Copy</li>
        <li data-action="paste">Paste</li>
        <hr>
        <li data-action="new_pkg">New package</li>
        <li data-action="new_cls">New class</li>
        <li data-action="new_intf" class="disabled">New interface (a disabled entry)</li>
    </ul>
*/
function handleMenuAction(dataAction) {
	alert("Action required: " + dataAction);
}
// ==================================================================











// ============================================================
// UserSettings
// ============================================================
let $userInfoDataContainerIsOpen = false;

function closedivUsuarioInfoContenedor() {
	document.getElementById("divUsuarioInfoContenedor").style.height = "0";
	document.getElementById("divUsuarioInfoContenedor").style.width = "0";
	$userInfoDataContainerIsOpen = false;
};

function opendivUsuarioInfoContenedor() {
	if(!$userInfoDataContainerIsOpen) {
		$userInfoDataContainerIsOpen = true;
		document.getElementById("divUsuarioInfoContenedor").style.height = "450px";
		document.getElementById("divUsuarioInfoContenedor").style.width = "340px";
	}
};
// ============================================================

//  Proyecto:
//      Tablero de Configuración
//          Areas de Negocio (Dpto. de contabilidad, Dpto. de rrhh, Dpto. de mercadeo, Dpto. de producción, etc.)
//          Usuarios
//          Perfiles
//          Sesiones
//          Actualizaciones
//      Proyectos
//          COMPONENTES (necesarios para el proyecto)
//              GESTIÓN DE DOCUMENTOS (pdf, planos, txt, anexos, imágenes, documentos fotos, videos, etc.)
//              GESTIÓN DE CAPITAL HUMANO (personal necesario para el proyecto)
//              GESTIÓN DE LOCALIZACIÓN GEOGRÁFICA (módulo de Stanly)
//              GESTIÓN DE FINANZAS (erp)
//              GESTIÓN DE CÓDIGO FUENTE (muy usado por los programadores, una versión mejorada de GIT)
//              GESTION DE MANTENIMIENTO DE ACTIVOS (asset management)
//              GESTIÓN DE MENSAJERÍA ELECTRÓNICA (correo, sms, whatsapp, etc)
//          Tipos
//              PROYECTO DESARROLLO SOFTWARE
//              PROYECTO IMPLEMENTACIÓN
//              PROYECTO CONSTRUCCION
//              PROYECTO EDUCATIVO
//              PROYECTO DEPORTIVO
//              PROYECTO DE INGENIERÍA
//              PROYECTO DE ENERGÍA Y ELECTRICIDAD
//              PROYECTO DE AUTOMATIZACIÓN
//              PROYECTO MÉDICO
//              PROYECTO ADMINISTRATIVO
//              PROYECTO SOCIAL
//              PROYECTO INVESTIGACIÓN
//              PROYECTO DE CIENCIAS POLÍTICAS (usado por los políticos en época electoral para mediciones, encuestas, etc)
//      Clientes
//      Proveedores
//          de Servicios
//          de Insumos
//      Finanzas
//          Presupuestos
//          Contabilidad
//          Compras
//          Ventas
//      Inventarios
//      Centro de Soporte & Helpdesk
//      Gestion de Documentos
//      GESTIÓN DE CAPITAL HUMANO
//      Gestion de Mantenimiento de Equipos

// window.navigator.onLine;
// determina acceso a la red, pero no a internet
// ============================================================



// ocultar algo
// $('.claseObjeto').delay(500).fadeOut(700);
// $('#objeto').delay(500).fadeOut(700);
// mostrar algo
// $('.claseObjeto').delay(500).fadeIn(700);
// $('#objeto').delay(500).fadeIn(700);
// $('#objeto').delay(500).fadeIn(700, function() {
//    // Al terminar animacion....
// })




// fade-out between pages
// $('body').delay(500).fadeOut(1000, function() {}) // Ocultar
// $('body').delay(500).fadeIn(1000, function() {}) // Mostrar




/*
    var isCtrl = false;
    document.onkeyup = function(e) {
        if (e.which == 17) isCtrl = false;
    };
    document.onkeydown = function(e) {
        if (e.which == 17) isCtrl = true;
        if (e.which == 85 && isCtrl == true) {
            alert('There are things you simply should not see.');
            return false;
        }
    };
*/



// ============================================================
// setTimeout(function, milliseconds)
// Executes a function, after waiting a specified number of milliseconds.
// ============================================================
// setInterval(function, milliseconds)
// Same as setTimeout(), but repeats the execution of the function continuously.
// ============================================================




/*



	isHidden : function(element) {
		if(element.css('display')== 'none') {
			return true;
		}
		return false;







	 Function places an element at the center of the page

	placeAtCenter : function(element) {
		element.css("position","absolute");
		element.css("top", ((jQuery(window).height() - element.outerHeight()) / 2) + jQuery(window).scrollTop() + "px");
		element.css("left", ((jQuery(window).width() - element.outerWidth()) / 2) + jQuery(window).scrollLeft() + "px");
	}





		*/
