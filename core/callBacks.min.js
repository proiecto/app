/**
* @preserve ====================================================================
* Copyright 1997, 2021. Proiecto, C. A. Todos los derechos reservados.
* Proiecto, Proiecto BackOffice, Proiecto BackOffice Server, Proiecto Salomón
* y Proiecto Web Services, son marcas registradas de Proiecto, C. A.
* El eslogan: 'Plataforma de servicios en la nube', es marca registrada de
* Proiecto, C. A. Otros productos citados son marcas registradas de sus
* respectivos propietarios y/o fabricantes.
* Producto desarrollado por Edward Ocando con licencia para uso exclusivo de
* Proiecto, C. A. Para más información visite https://www.proiecto.net, ó 
* si lo desea, puede escribir a: 
* info@proiecto.net, ventas@proiecto.net ó soporte@proiecto.net
* ====================================================================
* THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
* LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
* OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
* WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
* ====================================================================
*/
"use strict";

// ============================================================
// Funcion llamadora que se ejecurta en BackGround
// cada --> $appConfig.sessionTokenTimeRefresh segundos
// ============================================================
// Validar acceso a 
//	http://services.proiecto.net
// 		--> http://services.proiecto.net:1520/portal/validarAccesoBackOfficeServer
// ============================================================
let intervalID = setInterval(function() {
	if($alertaAvisoActivo) { 
		return false; 
	};

	if($sessionToken.accesoRed) {
		$.when(
				validarAccesoBackOfficeServer(), 	// 1er LUGAR (IMPORTANTE) --> SÓLO VALIDA ACCESO, NO MUESTRA MENSAJE.
				validarSessionTimeOut(),			// 2do LUGAR (IMPORTANTE) --> DETECTAR INACTIVIDAD DEL USUARIO
				numeroDeServiciosEnCluf(),		// 3er LUGAR (IMPORTANTE) --> CONTAR NÚMERO DE SERVICOS DE UN CLUF
			)
			.then(function() {
				// 1er ORDEN
				validarCluf();					// 4to LUGAR. VALIDAR CLUF QUE SEA VÁLIDO Y ESTATUS = ACTIVO
			})
			.done(function() {
				// 2do ORDEN
				ultimaFuncion();
			})
			.fail(function(jqXHR, textStatus, errorThrown) {
				var xResult = jQueryAjaxAvisoError('CallBacks to sessionTokenTimeRefresh fail.');
			});
	} else {
		alertaNoAccesoRed();
	}
	// ============================================================
}, ($appConfig.sessionTokenTimeRefresh));



// ============================================================
// 1er LUGAR (IMPORTANTE) - NO MUESTRA MENSAJES
// Sólo valida el acceso a la url del ws y actualiza
// ============================================================
function validarAccesoBackOfficeServer() {
	const $url = $appConfig.backOfficeServerUrl + "validar/validarAccesoBackOfficeServer";
	// "https://backoffice.proiecto.ws/validar/validarAccesoBackOfficeServer";
	// {"message": "success", "result": 12207}
	var jqXHR = $.ajax({
		headers: { 'Access-Control-Allow-Origin': '*' },
		method: "GET", // "POST", "GET", "PUT" (default: 'GET')
		url: $url,
		contentType: "application/json; charset=utf-8", // "application/javascript"
		dataType: 'json',
		data: {},
		crossDomain: true,
		timeout: $appConfig.ajaxCallTimeOut,
		cache: false,
		async: true, // default: true
		beforeSend: function(jqXHR) {
			// ...
		},
		success: function(data) {
			if(!data) {
				$sessionToken.accesoRed = false;
				alertaNoAccesoBackOfficeServer();
			} else {
				var jsOBJ = JSON.parse(JSON.stringify(data));
				if(jsOBJ.result > 0) { // siempre regresa un número mayor que 0
					$sessionToken.accesoRed = true;
					return true;
				} else {
					$sessionToken.accesoRed = false;
					alertaNoAccesoBackOfficeServer();
				}
			}
		},
		error: function(jqXHR, textStatus, errorThrown) {
			$sessionToken.accesoRed = false;
			var xResult = jQueryAjaxAvisoError('validarAccesoBackOfficeServer()');
			return false;
		}
	});
	return jqXHR;
};
// ============================================================


// ============================================================
// 2do LUGAR (IMPORTANTE)
// DETECTAR INACTIVIDAD DEL USUARIO
// ============================================================
function validarSessionTimeOut() {
	// ============================================================
	// Calcular diferencia de 13 minutos de inactividad = (780 * 1000) = 780,000 milisegundos
	// En TODOS los módulos donde hay interaccion del usuario, colocar siempre:
	// 	--> $sessionToken.ultimaVerificacionToken = new Date();
	// ============================================================
	// $appConfig.sessionLocalTimeOut --> 780,000;
	if((new Date() - $sessionToken.ultimaVerificacionToken) > $appConfig.sessionLocalTimeOut) {
		if(localStorage.getItem('sessionToken')) {
			// Esto ocurre sólo si hay una sesión activa
			// El usuario ha hecho login correcto
			$.toast({
				heading: l("AVISO"),
				text: l("SESION_TERMINADA"),
				hideAfter: 7000,
				beforeShow: function () {
					$BCL.clearCache(true);
					tokenReset();
					clearInterval(intervalID);
				},
				afterShown: function () {},
				afterHidden: function () {
					$("html").fadeOut(1200); // Oculta
					window.location.replace('../@portal/logout/');
				},
				onClick: function () {},
				beforeHide: function() {}
			});
		} else {
			tokenReset();
		};
	};
	return true;
};
// ============================================================

// ============================================================
// 3er LUGAR (IMPORTANTE)
// Obtener cantidad de servicios asociados a una empresa (CLUFS)
// Empresa activa --> $BCL.getUrlSubDomain() -> 'demo'
// Usado para determinar si una CLUFS esta o no activo cuando el resultado es = 0
// El resultado se almacena en --> $sessionToken.numeroDeServiciosEnCluf
//	--> {"message": "success", "result": 10}
// ============================================================
function numeroDeServiciosEnCluf() {
	// =============================================================
	if(!$sessionToken.accesoRed) { alertaNoAccesoRed(); return; }
	// =============================================================
	var result = 0;
	var $url = $appConfig.salomonWebServicesUrl + "proiecto/isClufsEnabled/?url=" + $BCL.getUrlSubDomain();
	// https://salomon.proiecto.ws/proiecto/isClufsEnabled/?url=banesco
    	// https://salomon.proiecto.ws/proiecto/isClufsEnabled/?url=proiecto
    	// https://salomon.proiecto.ws/proiecto/isClufsEnabled/?url=ibm
    	// https://salomon.proiecto.ws/proiecto/isClufsEnabled/?url=dell
    	// https://salomon.proiecto.ws/proiecto/isClufsEnabled/?url=www
    	// https://salomon.proiecto.ws/proiecto/isClufsEnabled/?url=none

	var jqXHR = $.ajax({
		headers: { 'Access-Control-Allow-Origin': '*' },
		method: "GET", // "POST", "GET", "PUT" (default: 'GET')
		url: $url,
		contentType: "application/json; charset=utf-8", 
		dataType: 'json',
		data: {},
		crossDomain: true,
		timeout: $appConfig.ajaxCallTimeOut,
		cache: false,
		async: true, // default: true IMPORTANT!
		beforeSend: function(jqXHR) {
			// ...
		},
		success: function(data) {
			// {"message": "success", "result": 10}
			// {"message": "success", "result": 0}
			if(!data) {
				result = -1;
				var xResult = jQueryAjaxAvisoError('Bad response from isClufsEnabled.');
			}
			// ============================================================
			// [data] viene de la vista:
			//	--> SELECT count(*) FROM dbo.VISTA_CLUFS_SERVICIOS WHERE CLUF_ALIAS = @urlAlias
			// ============================================================
			// console.table(data);
			// console.table(data.message); 	// success
			// console.table(data.result); 	// 10
			$sessionToken.numeroDeServiciosEnCluf = data.result;
		},
		error: function(jqXHR, textStatus, errorThrown) {
			result = -1;
			var xResult = jQueryAjaxAvisoError('numeroDeServiciosEnCluf()');
		}
	});
	return jqXHR;
};
// ============================================================

// ============================================================
// ToDo - 4to LUGAR. 
// VALIDAR CLUF QUE SEA VÁLIDO Y ESTATUS = ACTIVO
// ============================================================
function validarCluf() {
	// Validar que el Cluf este al dia, y sea correcto
	// 	https://salomon.proiecto.ws/proiecto/validateCluf/?url=www
     // 	https://salomon.proiecto.ws/proiecto/validateCluf/?url=proiecto
     // 	https://salomon.proiecto.ws/proiecto/validateCluf/?url=banesco

	// ============================================================
	// Sí no es válido:
	// ============================================================
	if ($sessionToken.numeroDeServiciosEnCluf < 1){
		//	$sessionToken.ultimaVerificacionToken = new Date();
		// 	$BCL.clearCache(true);
		// 	tokenReset();
		// 	clearInterval(intervalID);
		// 	$("html").fadeOut(1200); // Oculta
		// 	window.location.replace('../@portal/logout/');
	};

	// ============================================================
	// Sí es válido, no pasa nada....
	// ============================================================
	return true;
};
// ============================================================


// ============================================================
// ULTIMO LUGAR (IMPORTANTE)
// ============================================================
function ultimaFuncion() {
	return true;
};
// ============================================================




// ============================================================
// DE USO INTERNO
// ============================================================
function alertaNoAccesoBackOfficeServer() {
	// ============================================================
	// No notificar si hay un aviso en pantalla
	// ============================================================
	if($alertaAvisoActivo) { return false; };
	$alertaAvisoActivo = true;
	// ============================================================
	$.alert({
		boxWidth: '90%',
		useBootstrap: false,
		animation: 'opacity',
		closeAnimation: 'scale',
		animationBounce: 2, // default is 1.2 whereas 1 is no bounce.
		escapeKey: false,
		closeIcon: false,
		// closeIconClass: 'fa fa-close',
		draggable: true,
		type: 'red',
		icon: 'fa fa-hand-stop-o',
		title: l('AVISO_NO_CONEXION_BACKOFFICE_TITULO'),
		dragWindowGap: 100,
		content: l('AVISO_NO_CONEXION_BACKOFFICE_CONTENIDO'),
		onDestroy: function() {
			$alertaAvisoActivo = false;
			return true;
		}
	});
};
// ============================================================





